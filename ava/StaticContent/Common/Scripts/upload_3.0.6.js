var globalStrNome;var globalStrDescricao;var globalAuxCancelar=false;var globalAuxSlide=false;var arraySelecionados=[];var arraySelecionadosHtml=[];var jcrop_api;var bolCrop=false;var bolTamanhoImg=false;var globalSelecionados=false;var idArquivoGlobalAux=0;var strNomeArquivoGlobalAux="";var bolAuxDeletarimg=false;var imgPerfilAtualAux="";var bolAtualizouContador=false;var bolListouArquivosBiblioteca=false;var bolCarregouPreSelecionados=false;window.onbeforeunload=function(a){deletarImagemProcessoIncompleto(idArquivoGlobalAux,strNomeArquivoGlobalAux,false)};function windowBeforeUnload(){deletarImagemProcessoIncompleto(idArquivoGlobalAux,strNomeArquivoGlobalAux,false)}function offBeforeUnload(a){$(window).off("beforeunload")}jQuery(function(b){var a=b("#idFerramentaTipo").val();AtualizaContador();imgPerfilAtualAux=b("#imgPerfilAtualAux").val();ListaArquivosBiblioteca(a,0);b(".tabs a").click(function(){b(".tabs li").removeClass("active");b(this).parent().addClass("active")});b("#btn_cancelar").click(function(){window.close()});b("#btn_salvarGeral").click(function(){if(!b("#btn_salvarGeral").hasClass("disable")){bolAuxDeletarimg=false;var c=b("#idFerramentaTipo").val();var e=b("#idFerramenta").val();var d=0;if(!validaBolCrop()){if(arraySelecionados.length>0){b("#btn_salvarGeral").addClass("disable");b.ajax({async:false,data:{idFerramentaTipo:c,idsArquivos:arraySelecionados.join(";")},dataType:"json",error:function(h,f,g){alert("Erro: "+g+"Status: "+f);b("#btn_salvarGeral").removeClass("disable")},success:function(i,g){var f=jQuery.parseJSON(JSON.stringify(i));if(f.erro.length>0){jAlert(f.erro,"")}else{var h={arrayArquivo:f.jsonArray,idFerramenta:e,idFerramentaTipo:c};if(window.opener){if(window.opener.CallbackUpload){if(typeof(window.opener.CallbackUpload)=="function"){window.opener.CallbackUpload(h);window.close()}}}else if(window.parent){if(window.parent.opener){if(window.parent.opener.CallbackUpload){if(typeof(window.parent.opener.CallbackUpload)=="function"){window.parent.opener.CallbackUpload(h)}}}if(window.parent.CallbackUpload){if(typeof(window.parent.CallbackUpload)=="function"){window.parent.CallbackUpload(h)}}}}b("#btn_salvarGeral").removeClass("disable")},type:"POST",url:"/AVA/Upload/Home/RetornaJsonArquivos"})}else{alert("Favor selecionar um arquivo!")}}else{alert("Selecione uma imagem para recortar")}}});b("#btn_cancelarGeral").click(function(){if(window.opener){if(window.opener.CallbackCancelarUpload){if(typeof(window.opener.CallbackCancelarUpload)=="function"){window.opener.CallbackCancelarUpload();window.close()}}}if(window.parent){if(window.parent.opener){if(window.parent.opener.CallbackCancelarUpload){if(typeof(window.parent.opener.CallbackCancelarUpload)=="function"){window.parent.opener.CallbackCancelarUpload()}}}if(window.parent.CallbackCancelarUpload){if(typeof(window.parent.CallbackCancelarUpload)=="function"){window.parent.CallbackCancelarUpload()}}}window.close()})});function ListaArquivosBiblioteca(a,b){globalSelecionados=false;$(".lista_biblioteca").html("<img src='/AVA/StaticContent/Common/img/perfil/carregando.gif' border='0' />");var c=$("#strPesquisa").val();if(c==undefined){c="";$("#strPesquisa").val("")}$("#idBiblioteca").val(b);$.ajax({data:{idBiblioteca:b,idFerramentaTipo:a,strPesquisa:c},error:function(d){console.debug(d.status)},success:function(d){$(".lista_biblioteca").html(d);$(".up_tooltip").each(function(){$(this).tooltip({effect:"slide",offset:[10,40],opacity:1,position:"top center",relative:true})});$(".item_arquivo").mouseenter(function(){$(this).find(".detalhe_arquivo").animate({height:"40px"});$(this).find(".arq_menu_links").show()});$(".item_arquivo").mouseleave(function(){$(this).find(".detalhe_arquivo").animate({height:"15px"});$(this).find(".arq_menu_links").hide()});bolListouArquivosBiblioteca=true;ResetaSelecionados()},type:"POST",url:"/AVA/Upload/Home/ListaArquivosBiblioteca"})}function PesquisaArquivos(a){globalSelecionados=false;$(".lista_biblioteca").html("<img src='/AVA/StaticContent/Common/img/perfil/carregando.gif' border='0' />");var c=$("#strPesquisa").val();if(c==undefined){c="";$("#strPesquisa").val("")}var b=$("#idBiblioteca").val();$.ajax({data:{idBiblioteca:b,idFerramentaTipo:a,strPesquisa:c},error:function(d){console.debug(d.status)},success:function(d){$(".lista_biblioteca").html(d);$(".up_tooltip").each(function(){$(this).tooltip({effect:"slide",offset:[10,40],opacity:1,position:"top center",relative:true})});$(".item_arquivo").mouseenter(function(){$(this).find(".detalhe_arquivo").animate({height:"40px"});$(this).find(".arq_menu_links").show()});$(".item_arquivo").mouseleave(function(){$(this).find(".detalhe_arquivo").animate({height:"15px"});$(this).find(".arq_menu_links").hide()});ResetaSelecionados()},type:"POST",url:"/AVA/Upload/Home/ListaArquivosBiblioteca"})}function ResetaSelecionados(){var a=false;if(!bolCarregouPreSelecionados){if(bolListouArquivosBiblioteca&&bolAtualizouContador){bolCarregouPreSelecionados=true;a=true;if($("#hidden_idsArquivosSelecionados").length){var c=$("#hidden_idsArquivosSelecionados").val();if(c.length>0&&arraySelecionados.length==0){arraySelecionados=c.split(",")}}}}for(var b=0;b<arraySelecionados.length;b=b+1){var d=".idArq_"+arraySelecionados[b];$(d).addClass("select");$(d).prepend('<span class="ava_clips_seletor"></span>');if(a){arraySelecionadosHtml.push($(d)[0].outerHTML)}}if(arraySelecionados.length>0){$(".arquivoSelecionado").slideDown()}if(arraySelecionados.length==0){$(".arquivoSelecionado").slideUp()}if(arraySelecionados.length==0){}else{if(arraySelecionados.length==1){$(".arquivoSelecionado a").html("<strong>1</strong> arquivo selecionado")}else{$(".arquivoSelecionado a").html("<strong>"+arraySelecionados.length+"</strong> arquivos selecionados")}}Selecionados()}function Selecionados(){$(".item_arquivo").unbind("click").click(function(g){if(!$(g.target).hasClass("download")&&!$(g.target).hasClass("excluir")&&!$(this).find(".singleProgress").length){var f=$(this).attr("idArquivo");var b=false;var d=$("#idFerramenta").val();var a=$("#idFerramentaTipo").val();if(arraySelecionados.length>0){for(var c=0;c<arraySelecionados.length;c=c+1){if(f==arraySelecionados[c]){$(this).removeClass("select");$(this).children("span").remove();removeItem(arraySelecionados,f);arraySelecionadosHtml.splice(c,1);b=true}}if(!b){arraySelecionados.push(f);$(this).addClass("select");$(this).prepend('<span class="ava_clips_seletor"></span>');arraySelecionadosHtml.push($(this)[0].outerHTML)}}else{arraySelecionados.push(f);$(this).addClass("select");$(this).prepend('<span class="ava_clips_seletor"></span>');arraySelecionadosHtml.push($(this)[0].outerHTML)}if(arraySelecionados.length>0){$(".arquivoSelecionado").slideDown()}if(arraySelecionados.length>0&&globalSelecionados){VisualizaSelecionados()}if(arraySelecionados.length==0){$(".arquivoSelecionado").slideUp();if(globalSelecionados){ListaArquivosBiblioteca(a,0)}$(".menu_arquivos").removeClass("active");$(".count_total").addClass("active")}else{if(arraySelecionados.length==1){$(".arquivoSelecionado a").html("<strong>1</strong> arquivo selecionado")}else{$(".arquivoSelecionado a").html("<strong>"+arraySelecionados.length+"</strong> arquivos selecionados")}}}})}function VisualizaSelecionados(){if(arraySelecionadosHtml.length>0){globalSelecionados=true;$(".lista_biblioteca").html("<img src='/AVA/StaticContent/Common/img/perfil/carregando.gif' border='0' />");$(".lista_biblioteca").html("");for(var a=0;a<arraySelecionadosHtml.length;a=a+1){$(".lista_biblioteca").prepend(arraySelecionadosHtml[a])}$(".up_tooltip").each(function(){$(this).tooltip({effect:"slide",offset:[10,40],opacity:1,position:"top center",relative:true})});$(".item_arquivo").mouseenter(function(){$(this).find(".detalhe_arquivo").animate({height:"40px"});$(this).find(".arq_menu_links").show()});$(".item_arquivo").mouseleave(function(){$(this).find(".detalhe_arquivo").animate({height:"15px"});$(this).find(".arq_menu_links").hide()});if(validaBolCrop()){Selecionados()}ResetaSelecionados()}else{globalSelecionados=false}}function removeItem(b,c){var a=0;while(a<b.length){if(b[a]==c){b.splice(a,1)}else{a=a+1}}return b}function AtualizaContador(){var a=$("#idFerramentaTipo").val();$.ajax({data:{idFerramentaTipo:a},dataType:"json",error:function(d,b,c){alert("Erro: "+c+"Status: "+b)},success:function(f,b){var d=0;if(f.length>0){var e;$(".menu_arquivos").empty();$(".menu_arquivos").append('<li onClick="VisualizaSelecionados()" class="arquivoSelecionado"><a href="javascript:void(0);"><strong>0</strong> arquivo selecionado</a></li>');if(f.length>1){$(".menu_arquivos").append('<li onCLick="ListaArquivosBiblioteca('+a+',0)" style="cursor:pointer;" class="active count_total"><a href="javascript:void(0);">Todos('+d+")</a></li>")}for(var c=0;c<f.length;c=c+1){e=c;e=e+1;$(".menu_arquivos").append('<li onclick="ListaArquivosBiblioteca('+a+","+f[c].idBilbioteca+')" style="cursor:pointer;"><a href="javascript:void(0)">'+f[c].strNomeBiblioteca+"("+f[c].intTotal+")</a></li>");d=d+f[c].intTotal}$(".count_total").html('<a href="javascript:void(0);">Todos('+d+")</a>");$(".menu_arquivos").append('<li style="display:none"><a href="javascript:void(0);" id="menu_andamento">Em andamento(0)</a></li>')}else{$(".menu_arquivos").append('<li onClick="VisualizaSelecionados()" class="arquivoSelecionado"><a href="javascript:void(0);"><strong>1</strong> arquivo selecionado</a></li>');$(".menu_arquivos").append('<li onCLick="ListaArquivosBiblioteca('+a+',0)" style="cursor:pointer" class="active"><a href="javascript:void(0);">Todos('+d+")</a></li>");$(".menu_arquivos").append('<li style="display:none"><a href="javascript:void(0);" id="menu_andamento">Em andamento(0)</a></li>')}$(".menu_arquivos li").click(function(){$(".menu_arquivos li").removeClass("active");$(this).addClass("active")});$(".arquivoSelecionado").hide();bolAtualizouContador=true;ResetaSelecionados()},type:"POST",url:"/AVA/Upload/Home/CountArquivosBiblioteca"})}function ExcluirArquivo(d){var b=".idArq_"+d;var a=confirm("Tem certeza que deseja excluir esse arquivo?");if(a==true){if(arraySelecionados.length>0){for(var c=0;c<arraySelecionados.length;c=c+1){if(d==arraySelecionados[c]){$(this).removeClass("select");$(this).children("span").remove();removeItem(arraySelecionados,d);arraySelecionadosHtml.splice(c,1);auxArq=true}}}$.ajax({data:{id:d},error:function(e){console.debug(e.status)},success:function(g){$(b).hide(500,function(){$(b).remove();AtualizaContador()});var e=$("#idFerramentaTipo").val();var f={idArquivo:d,idFerramentaTipo:e};if(window.opener.CallbackUploadExcluidos){window.opener.CallbackUploadExcluidos(f)}},type:"POST",url:"/AVA/Upload/Home/Excluir"})}}function AlternaAbas(c){deletarImagemProcessoIncompleto(idArquivoGlobalAux,strNomeArquivoGlobalAux,true);$(".visu_arquivos").hide();var b=$("#idBiblioteca").val();var a=$("#idFerramentaTipo").val();if(c==1){$(".add_arquivos").hide();ListaArquivosBiblioteca(a,0);$(".titulo_voltar").html("<h1>Arquivos</h1>");$(".meus_arquivos").show()}else{if(c==2){$(".meus_arquivos").hide();$(".add_arquivos").show();$("#permissoes_arquivos").html("<strong>Os formatos aceitos são:</strong> "+strExtensoes+".")}else{$(".add_arquivos").hide();$(".meus_arquivos").show()}}}function VisualizaArquivo(d,b){idArquivoGlobalAux=d;$(".meus_arquivos").hide();$(".titulo_voltar").html('<div class="arquivos_topo_voltar"><a href="javascript:void(0);" class="FontAwesome voltar_modal" id="btn_voltar"><span></span></a><h1>Arquivos</h1></div>');$(".lista_biblioteca").html("<img src='/AVA/StaticContent/Common/img/perfil/carregando.gif' border='0' />");var a=$("#idFerramentaTipo").val();var c=$("#idFerramenta").val();$.ajax({data:{idArquivo:d},error:function(e){console.debug(e.status)},success:function(g){bolAuxDeletarimg=true;$(".visu_arq").html(g);$(".visu_arquivos").show();$(".visu_arquivos").data("idarquivo",d);$("#btn_voltar").click(function(){$(".titulo_voltar").html("<h1>Arquivos</h1>");ListaArquivosBiblioteca(a,b);AlternaAbas(1);$("#strPesquisa").val("")});globalStrNome=$("#campo_nome p").text();globalStrDescricao=$("#campo_descricao p").text();$(".tooltip").css("display","none");$("#edita_nome").click(function(){var h=$("#strNome").val();$("#campo_nome").html('<input id="strNome" type="text" value="'+h+'" maxlength="60"/>')});$("#edita_desc").click(function(){var h=$("#strDescricao").val();$("#campo_descricao").html('<textarea id="strDescricao">'+h+"</textarea>")});if(validaBolCrop()&&b==3){var e=d;var f=getDadosImagem(e);if(f[2]){bolTamanhoImg=true;$(".select_corte").show();$("#imagem_crop").Jcrop({aspectRatio:1,bgColor:"black",bgOpacity:0.4,onSelect:showCoords},function(){jcrop_api=this;jcrop_api.setSelect(getRandom());$(".combo_recortar").show()});$(".cancela_recorte").click(function(h){jcrop_api.release();$("#x1").val("");$("#x2").val("");$("#y1").val("");$("#y2").val("");$(".combo_recortar").hide();return false});$(".select_corte").click(function(h){jcrop_api.setSelect(getRandom());$(".combo_recortar").show()});$(".recortar_imagem").click(function(){var m=$("#imagem_crop").attr("src");var i=$("#x1").val();var h=$("#x2").val();var k=$("#y1").val();var j=$("#y2").val();var l=$("#strNomeArquivo").val();var n=$("#strDirAqruivo").val();if(h==""||h<1||j==""||j<1){alert("Selecione uma Área da imagem para recorte.")}else{if(h<170||j<170){alert("Crop não tem o tamanho mínimo de 170 x 170 pixels.")}else{$.ajax({data:{idArquivo:d,srcImagem:m,strDirArquivo:n,strNomeArquivo:l,x1:i,x2:h,y1:k,y2:j},dataType:"json",error:function(q,o,p){alert("Erro: "+p+"Status: "+o)},success:function(p,o){strNomeArquivoGlobalAux=p.nomefinal;$("#img_padrao").html('<img src="'+p.imagem_recortada+'"/>');$(".recortar_imagem").hide();$(".combo_recortar").hide();$("#strDirArquivoCrop").val(p.imagem_recortada);$(".download").attr("href","/AVA/Upload/Home/ForceDownload?strSrcArquivo="+p.imagem_recortada);bolCrop=true;$(".select_corte").hide()},type:"POST",url:"/AVA/Upload/Home/Crop"})}}})}else{alert("Esta imagem não tem o tamanho mínimo de 170 x 170 pixels.");$(".recortar_imagem").hide()}}else{$(".recortar_imagem").hide()}},type:"POST",url:"/AVA/Upload/Home/SelecionaArquivo"})}function habilitaRecorte(){jcrop_api.setSelect(getRandom());$(".combo_recortar").show()}function getRandom(){var c=$("#idArquivo").val();var b=null;var a=null;$.ajax({async:false,contentType:"application/json; charset=utf-8",dataType:"json",error:function(f,d,e){alert("Erro: "+e+"Status: "+d)},success:function(e,d){b=e.width;a=e.height},type:"POST",url:"/AVA/Upload/Home/GetDadosImagem?idImagem="+c});posicao={};posicao.w=b;posicao.h=a;posicao.x=0;posicao.y=0;if(a<=b){posicao.x2=a;posicao.y2=a}else{posicao.x2=b;posicao.y2=b}showCoords(posicao);return[posicao.x,posicao.y,posicao.x2,posicao.y2]}function getDadosImagem(d){var c=null;var b=null;var a;$.ajax({async:false,contentType:"application/json; charset=utf-8",dataType:"json",error:function(g,e,f){alert("Erro: "+f+"Status: "+e)},success:function(f,e){c=f.width;b=f.height;a=f.boolTamanho},type:"POST",url:"/AVA/Upload/Home/GetDadosImagem?idImagem="+d});return[c,b,a]}function showCoords(a){$("#x1").val(a.x);$("#x2").val(a.x2);$("#y1").val(a.y);$("#y2").val(a.y2);$(".combo_recortar").show()}function AlterarArquivo(){var f=$("#idArquivo").val();var g=$("#strNome").val();var d=$("#strDescricao").val();var j=$("#idFerramenta").val();var i=$("#idFerramentaTipo").val();var h=$("#strNomeArquivo").val();var c=$("#strDirArquivoCrop").val();var e=c.split("/");e=e[e.length-1];e=e.split(".");e=e[0];if(g==""){alert("Nome do arquivo em branco.")}else{if(!bolTamanhoImg&&validaBolCrop()){alert("Esta imagem não tem o tamanho mínimo de 170 x 170 pixels.")}else{if(!bolCrop&&validaBolCrop()){alert("Imagem deve ser recortada.")}else{if(bolCrop&&validaBolCrop()){var b=null;var c=$("#strDirArquivoCrop").val();$.ajax({async:false,data:{idArquivo:f,idFerramentaTipo:i,imgPerfilAtualAux:imgPerfilAtualAux,nomeImgTemp:e},dataType:"json",error:function(k){console.debug(k.status)},success:function(l){var k=parseInt(l.error);if(k==0){b=l.strArquivo}else{fotoAlterada=true;alert(l.strArquivo)}},type:"POST",url:"/AVA/Upload/Home/SalvaArquivoPerfil"})}var a={id:f,strDescricao:d,strNome:g};$.ajax({async:false,contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{json:JSON.stringify(a)},error:function(k){if(k.status!=0){console.debug("Erro ao salvar arquivo.")}},success:function(l){var m=[];$.ajax({async:false,data:{idFerramentaTipo:i,idsArquivos:f.toString()},dataType:"json",error:function(p,n,o){alert("Erro: "+o+"Status: "+n)},success:function(p,o){var n=jQuery.parseJSON(JSON.stringify(p));if(n.erro.length>0){alert(n.erro)}else{m=n.jsonArray}},type:"POST",url:"/AVA/Upload/Home/RetornaJsonArquivos"});if(validaBolCrop()){m[0].strArquivo=b}bolAuxDeletarimg=false;alert("Arquivo alterado com sucesso!");localStorage.setItem("fotoAlterada","true");var k={arrayArquivo:m,idFerramenta:j,idFerramentaTipo:i};if(bolCrop&&validaBolCrop()){if(window.opener){if(window.opener.CallbackUpload){if(typeof(window.opener.CallbackUpload)=="function"){window.opener.CallbackUpload(k);window.close()}}}if(window.parent){if(window.parent.opener){if(window.parent.opener.CallbackUpload){if(typeof(window.parent.opener.CallbackUpload)=="function"){window.parent.opener.CallbackUpload(k)}}}if(window.parent.CallbackUpload){if(typeof(window.parent.CallbackUpload)=="function"){window.parent.CallbackUpload(k)}}}}},type:"POST",url:"/AVA/Upload/Home/AlteraArquivo"})}}}}function SalvaArquivoCropPerfil(){var a=$("#strDirArquivoCrop").val();$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{strDirArquivoCrop:a},error:function(b){console.debug(b.status)},success:function(b){},type:"POST",url:"/AVA/Upload/Home/SalvaArquivoPerfil"})}function ListaAndamento(){$(".add_arquivos").hide();$(".meus_arquivos").show()}function DownloadArquivo(a){var b=null;$.ajax({data:{caminhoArquivo:a,contentType:b},error:function(c){console.debug(c.status)},success:function(c){},type:"POST",url:"/AVA/Upload/Home/ForceDownload"})}function deletarImagemProcessoIncompleto(b,c,a){if(a===undefined||a==""||a==null){a=false}if(b!==undefined&&b!=""&&b!=0&&bolAuxDeletarimg){$.ajax({async:a,data:{idarquivo:b,nomeArquivo:c},dataType:"json",error:function(d){},success:function(e){strNomeArquivoGlobalAux="";idArquivoGlobalAux=0;var d=parseInt(e.error);bolAuxDeletarimg=false;if(d==0){console.log(e.msg)}else{console.log(e.msg)}},type:"POST",url:"/ava/upload/home/removerImagemTrocarAbaOuFecharJanela"})}}function ExcluirArquivoFerramenta(b,a){$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:{idArquivo:b,idFerramenta:a},error:function(c){console.debug(c.status)},success:function(c){},type:"POST",url:"/AVA/Upload/Home/ExcluiArquivoFerramenta"})}function validaBolCrop(){var a=$("#bolSomenteImgCrop").val();if(a=="False"){a=false}else{a=true}return a};