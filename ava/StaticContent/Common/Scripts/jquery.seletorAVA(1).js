function montaJSON(e, t) { json = {}; json.turmas = []; json.usuarios = []; if (t === undefined || t == "") { json.StrMensagem = jQuery("#txtInput").val().replace(/\r?\n|\r/g, "<br>") } e.find("li").each(function () { if (jQuery(this).hasClass("turma")) { if (jQuery(this).find(".small").hasClass("parcial")) { jQuery(this).find("input[type=hidden]").each(function () { var e = false; var t = jQuery(this); jQuery(json.usuarios).each(function () { if (jQuery(this).attr("id") == t.attr("ident")) { e = true; return false } }); if (!e) { json.usuarios.push({ id: jQuery(this).attr("ident") }) } }) } else { var e = false; var t = jQuery(this); jQuery(json.turmas).each(function () { if (jQuery(this).attr("id") == t.attr("ident")) { e = true; return false } }); if (!e) { json.turmas.push({ id: jQuery(this).attr("ident") }) } } } else if (jQuery(this).hasClass("unico")) { jQuery(this).find("input[type=hidden]").each(function () { var e = false; var t = jQuery(this); jQuery(json.usuarios).each(function () { if (jQuery(this).attr("id") == t.attr("ident")) { e = true; return false } }); if (!e) { json.usuarios.push({ id: jQuery(this).attr("ident") }) } }) } else if (jQuery(this).hasClass("especifico")) { var e = false; var t = jQuery(this); jQuery(json.usuarios).each(function () { if (jQuery(this).attr("id") == t.attr("ident")) { e = true; return false } }); if (!e) { json.usuarios.push({ id: jQuery(this).attr("ident") }) } } }); return jQuery.toJSON(json) } function retira_acentos(e) { var t = "‡ËÏÚ˘‚ÍÓÙ˚‰ÎÔˆ¸·ÈÌÛ˙„ıÁ¿»Ã“Ÿ¬ Œ‘€ƒÀœ÷‹¡…Õ”⁄√’«_ "; var n = "aeiouaeiouaeiouaeiouaocAEIOUAEIOUAEIOUAEIOUAOC--"; var r = "¥`^®~!@#$%&*()+=£¢ß™∫∞{}[]|\\/?:;.,<>\"'"; novaPalavra = ""; contador = 0; for (i = 0; i < e.length && i <= 140; i++) { letra = e.charAt(i); if (r.indexOf(letra) == -1) { if (t.indexOf(letra) == -1) { novaPalavra += letra; contador++ } else { if (!(novaPalavra.charAt(contador - 1) == "-" && n.charAt(t.indexOf(letra)) == "-")) { novaPalavra += n.charAt(t.indexOf(letra)); contador++ } } } } return novaPalavra } (function ($) { $.fn.seletorAVA = function (opcoes) { var defaults = { turma: true, seguidor: false, professor: false, callBack: null, attachBox: null, mural: false }; var s = $.extend(defaults, opcoes); return this.each(function () { function retornaJsonSelecao(e, t) { function n(e) { var t = null; t = e.Result; totalCarteirinhas = e.Result.length; $("#myContentTemplate").tmpl(e).appendTo("#ava_contentlista"); $("#ava_contentlista #ava_loader").css("display", "none"); $("#ava_contentlista").find(".carteirinha").each(function () { var e = ""; if (_personalizando.closest("li").find("input[type=hidden][ident=" + $(this).attr("ident") + "]").length > 0) { i_carteirinhas++; $(this).addClass("carteirinha_selected") } }); $("#txtFiltroAva").live("keyup", function () { if ($(this).attr("idusuario")) { _id = $(this).attr("idusuario") } else { _id = 0 } FiltrarUsuarioSelecao("#ava_contentlista", t, $(this).val(), _id) }); $("#txtFiltroAva").live("focus", function () { if ($(this).val() == "Filtrar por nome") { $(this).val("") } }); $("#txtFiltroAva").live("blur", function () { if ($(this).val() == "") { $(this).val("Filtrar por nome") } }) } if (_meus_grupos[t]) { n(_meus_grupos[t]) } else { $.getJSON(e, null, function (e) { n(e); _meus_grupos[t] = e }) } } function FiltrarUsuarioSelecao(e, t, n, i) { $(e).html(""); if (n) { var s = false; for (r = 0; r < t.length; r++) { if (t[r].strNome.toLowerCase().indexOf(n.toLowerCase()) > -1) { if (t[r].id != i) { s = true; var o = ""; o = populaFiltroSelecao(t[r]); $(e).append(strBuilder) } } } if (!s) { var u = "'" + n + "'"; $(e).html('<span class="letter-spacing">Nenhum resultado encontrado. Que tal <a href="javascript: procurarpessoas(' + u + ')">procurar pessoas?</a></span>') } } else { for (r = 0; r < t.length; r++) { var o = ""; if (t[r].id != i) { o = populaFiltroSelecao(t[r]); $(e).append(strBuilder) } } } } function populaFiltroSelecao(e) { var t = ""; var n = ""; var r = ""; if (_personalizando.closest("li").find("input[type=hidden][ident=" + e.id + "]").length > 0) { r = "carteirinha_selected" } strBuilder = '<div class="carteirinha ' + r + '" id="cart_' + e.id + '" ident="' + e.id + '" style="cursor:pointer;"><div class="in_cT"><span class="ava_clips"></span>'; if (e.bolEducador) { strBuilder += '<div class="souProf"><span>Professor</span></div>' } if (e.strFoto.length <= 0) { n = "/AVA/StaticContent/Common/img/perfil/avatar.jpg" } else { n = e.strFoto } strBuilder += '<a><img src="' + n + '" width="55" height="55" alt="avatar">' + e.strNome.substring(0, 9) + "</a>"; if (e.bolSigoAuto) { } else if (e.bolPossoSeguir && !e.bolEstouSeguindo) { } else { } strBuilder += "</div></div>"; return strBuilder } function AttachLightBoxAVA(e) { var t = e.closest("li").attr("ident"); if (t !== undefined) { e.attr("href", "/AVA/Perfil/Home/SelecaoRede?tipo=" + t); o = { autoSize: false, width: 700, height: 470, type: "ajax", afterShow: function () { var e = $(this.element).parent().attr("ident"); $urlSeguidosCompleto = "/AVA/Perfil/Home/SelecaoJSON?tipo=" + e; retornaJsonSelecao($urlSeguidosCompleto, e) }, beforeClose: function () { _personalizando = null }, helpers: { overlay: { locked: false}} }; lightBoxAVA(e, o) } } var _compartilhamento = $(this).find(".compartilhamento"); var _troca_persona = _compartilhamento.find(".troca_persona"); var _selecao_personas = $(this).find(".selecao_personas"); _selecao_personas.find("li:first").text("Selecione grupos e pessoas"); var _campo_busca = $(this).find(".campo-busca"); var _busca_especifico = $(this).find(".busca_especifico").attr("placeholder", "Digite Aqui"); var _p_a_perso = $(this).find(".p-a-perso"); if (s.turma == true && s.professor == false && s.seguidor == false) { _compartilhamento.find(".todos").find("a:first").text("Minhas turmas ") } if (s.attachBox != null) { if (s.attachBox.constructor.toString().indexOf("Array") > -1) { var inc = 0; for (inc = 0; inc < s.attachBox.length; inc++) { AttachLightBoxAVA(s.attachBox[inc]) } } else { AttachLightBoxAVA(s.attachBox) } } var _personalizando = null; var _editando = null; _compartilhamento.find(".todos").find(".small").click(function (e) { e.preventDefault() }).css("cursor", "default"); _troca_persona.toggle(function (e) { e.preventDefault(); _selecao_personas.fadeIn("fast"); _campo_busca.fadeIn().find("input").focus(); _troca_persona.text("Concluir ") }, function (e) { e.preventDefault(); _selecao_personas.hide(); _campo_busca.hide(); _troca_persona.text("Selecionar "); if (jQuery("#txtInput").val() != "" && _compartilhamento.find(".small").length > 0) { $("#compartilhar").removeClass("disable"); $("#compartilhar").bind("click", validaMensagemRapida) } }); var _meus_grupos = new Array; _selecao_personas.find(".p-a-default").live("click", function (e) { e.preventDefault(); var t = $(this).closest("li"); var n = $(this).closest("li").clone(); n.css("display", "none"); n.find("a.p-a-perso").remove(); n.find(".p-a-default-img").remove(); n.find("a:first").attr("class", "small awesome awesome-color"); n.append('<a class="small-x awesome-x awesome-x-color" href="#">x</a>'); if (!n.hasClass("especifico") && !n.hasClass("todos")) { n.find("a:first").attr("class", "small awesome awesome-color seletorlightbox"); AttachLightBoxAVA(n.find(".seletorlightbox")) } else { n.find(".small").css("cursor", "default").click(function (e) { e.preventDefault() }); _troca_persona.text("Concluir ") } n.find("span.discreto").removeClass("discreto"); var i = true; _compartilhamento.find("li").each(function (e) { if ($(this).hasClass("turma")) { $(this).find("input").each(function () { if ($(this).attr("ident") == n.attr("ident")) { i = false } }) } else if ($(this).hasClass("especifico")) { if ($(this).attr("ident") == n.attr("ident")) { i = false } } }); if (i) { if (n.hasClass("unico")) { if (_meus_grupos[n.attr("ident")]) { if (!_personalizando) { for (r = 0; r < _meus_grupos[n.attr("ident")].Result.length; r++) { n.find("a:last").after('<input type="hidden" ident="' + _meus_grupos[n.attr("ident")].Result[r].id + '">') } } _troca_persona.closest("li").before(n) } else { $.getJSON("/AVA/Perfil/Home/SelecaoJSON?tipo=" + n.attr("ident"), null, function (e) { _meus_grupos[n.attr("ident")] = e; if (!_personalizando) { for (r = 0; r < e.Result.length; r++) { n.find("a:last").after('<input type="hidden" ident="' + e.Result[r].id + '">') } } _troca_persona.closest("li").before(n); _troca_persona.text("Concluir ") }) } } else { _troca_persona.closest("li").before(n) } } else { _troca_persona.click(); _troca_persona.text("Selecionar "); _busca_especifico.val(""); i = true } if (n.hasClass("especifico")) { _busca_especifico.keyup() } n.fadeIn(); if (t.hasClass("unico") || t.hasClass("especifico")) { _compartilhamento.find("li.todos").find(".small-x").click() } if (!i) { if (_compartilhamento.find(".small").length <= 0) { _troca_persona.text("+ Adicionar pessoas ") } else { _troca_persona.text("Concluir ") } } if (t.hasClass("todos")) { _compartilhamento.find(".unico, .especifico").each(function () { $(this).find(".small-x").click() }) } t.remove() }); _todos_clone = null; _compartilhamento.find(".small-x").live("click", function (e) { e.preventDefault(); var t = $(this).closest("li"); var n = $(this).closest("li").clone(); if (!_todos_clone && t.hasClass("todos")) { _todos_clone = t } if (!n.hasClass("especifico")) { n.css("display", "none"); n.find("a.small-x").remove(); n.find("a:first").attr({ "class": "p-a-default" }).css("cursor", "pointer"); n.append('<a class="p-a-perso invert" href="#">Personalizar</a></li>'); AttachLightBoxAVA(n.find(".p-a-perso")); _el_aux = null; if (_selecao_personas.find(".especifico").length > 0 || _selecao_personas.find("li.especifico-nenhum").length > 0) { _ul_aux = _ul_rede_original } else { _ul_aux = _selecao_personas.find("ul") } if (n.hasClass("todos")) { n.addClass("p_all p_bg"); n.find(".p-a-perso").remove(); _ul_aux.find("li:first").after(n) } else { _ul_aux.find("li:last").after(n) } n.find("input[type=hidden]").remove(); n.find("span").text("(" + n.find("span").attr("all_el") + ")").addClass("discreto"); n.fadeIn(); t.remove() } else { t.remove(); if (_busca_especifico.val() != "") { _busca_especifico.keyup() } } if (_compartilhamento.find(".small").length <= 0) { _troca_persona.text("+ Adicionar pessoas "); if (s.mural) { $("#compartilhar").addClass("disable"); $("#compartilhar").unbind("click", validaMensagemRapida) } } else { } }); _troca_persona.one("click", function () { $.ajax({ type: "POST", url: "/AVA/Perfil/Home/SelecaoElementosCompartilhar/", data: "turma=" + s.turma + "&seguidor=" + s.seguidor + "&professor=" + s.professor, success: function (html) { _selecao_personas.hide(); _selecao_personas.html(html); _selecao_personas.children("ul:first").find(".unico").each(function () { var e = $(this); $("#dadosAuxAgenda .compartilhamento").children("ul:first").find(".unico").each(function () { var t = $(this); if (e.attr("ident") == t.attr("ident")) { e.remove() } }) }); _selecao_personas.show(); _busca_especifico.fadeIn("fast").focus(); _p_a_perso = $(".p-a-perso"); var _els = _p_a_perso; _els.each(function () { AttachLightBoxAVA($(this)) }); if (_todos_clone) { _compartilhamento.find(".todos").remove(); _todos_clone.appendTo(_compartilhamento.find("ul")).find(".small-x").click() } if (s.callBack) { eval(s.callBack + "();") } } }) }); var xmlRede = null; var xmlRede_trigger = null; var _ul_rede_original = null; _busca_especifico.one("keyup", function () { _ul_rede_original = _selecao_personas.find("ul").clone(); _selecao_personas.html('<ul><li style="text-align:center;margin:10px 0;width:150px" class=""><img border="0" src="/AVA/StaticContent/Common/img/perfil/carregando.gif"></li></ul>'); $.getJSON("/AVA/Perfil/Home/SelecaoRedeCompleta/", { turma: s.turma, professor: s.professor, seguidor: s.seguidor }, function (e) { xmlRede = e.Result; _busca_especifico.live("keyup", function () { if ($(this).val() != "") { if (!_ul_rede_original) { _ul_rede_original = _selecao_personas.find("ul").clone() } _selecao_personas.find("ul").html(""); var e = 0; for (r = 0; r < xmlRede.length; r++) { var t = ""; var n = ""; t = retira_acentos(xmlRede[r].strNome.toLowerCase()); n = retira_acentos(xmlRede[r].strApelido.toLowerCase()); if ((xmlRede[r].strNome.toLowerCase().indexOf($(this).val().toLowerCase()) > -1 || t.indexOf($(this).val().toLowerCase()) > -1 || n.indexOf($(this).val().toLowerCase()) > -1 || xmlRede[r].strApelido.toLowerCase().indexOf($(this).val().toLowerCase()) > -1) && _compartilhamento.find(".especifico[ident=" + xmlRede[r].id + "]").length <= 0) { bolTemUser = true; var i = ""; _selecao_personas.find("ul").append('<li ident="' + xmlRede[r].id + '" class="especifico"><a class="p-a-default p-a-default-img" href="#"><img height="28" width="28" src="' + xmlRede[r].strMiniFoto + '"> </a><a class="p-a-default" href="#">' + xmlRede[r].strApelido + " </a></li>"); e++ } if (e > 4) { break } } if (e == 0) { _selecao_personas.find("ul").append('<li class="p_bg p_dica discreto especifico-nenhum">Nenhum usu·rio encontrado.</li>') } } else { if (_ul_rede_original) { _selecao_personas.html(_ul_rede_original) } _selecao_personas.find(".p-a-perso").each(function () { AttachLightBoxAVA($(this)) }); _ul_rede_original = null } }); if (!xmlRede_trigger) { xmlRede_trigger = 1; _busca_especifico.keyup() } }) }); var totalCarteirinhas = 0; var totalCarteirinhasSelecionadas = 0; var i_carteirinhas = 0; $(".carteirinha").live("click", function (e) { if (_personalizando) { if ($(this).find(".bt_seguir").length <= 0) { e.preventDefault() } var t = _personalizando.closest("li").attr("ident"); var n = $(this); var r = true; _compartilhamento.find("li").each(function (e) { if ($(this).hasClass("turma")) { if ($(this).find("input").attr("ident") == n.attr("ident")) { r = false } } else if ($(this).hasClass("especifico")) { if ($(this).attr("ident") == n.attr("ident")) { r = false } } }); if (r || $("#cart_" + n.attr("ident")).hasClass("carteirinha_selected")) { if (n.hasClass("carteirinha_selected")) { if (i_carteirinhas == 1) { _compartilhamento.find("li[ident=" + t + "]").find(".small-x").click(); _personalizando = _selecao_personas.find("li[ident=" + t + "]").find(".p-a-perso") } i_carteirinhas--; $(this).removeClass("carteirinha_selected"); _compartilhamento.find("li[ident=" + t + "]").find("input[type=hidden][ident=" + n.attr("ident") + "]").remove(); if (_compartilhamento.find("li[ident=" + t + "]").find(".small").hasClass("awesome-color")) { _compartilhamento.find("li[ident=" + t + "]").find(".small").removeClass("awesome-color").addClass("parcial"); _compartilhamento.find("li[ident=" + t + "]").find(".small-x").removeClass("awesome-x-color").addClass("parcial-x") } } else { if ($("#ava_contentlista").find(".carteirinha_selected").length <= 0) { _selecao_personas.find("li[ident=" + t + "]").find(".p-a-default").click(); _compartilhamento.find("li[ident=" + t + "]").find(".small").removeClass("awesome-color").addClass("parcial"); _compartilhamento.find("li[ident=" + t + "]").find(".small-x").removeClass("awesome-x-color").addClass("parcial-x"); _personalizando = _compartilhamento.find("li[ident=" + t + "]").find(".small") } i_carteirinhas++; $(this).addClass("carteirinha_selected"); _compartilhamento.find("li[ident=" + t + "]").append('<input type="hidden" ident="' + n.attr("ident") + '">'); if (totalCarteirinhas == i_carteirinhas) { _compartilhamento.find("li[ident=" + t + "]").find(".small").removeClass("parcial").addClass("awesome-color"); _compartilhamento.find("li[ident=" + t + "]").find(".small-x").removeClass("parcial-x").addClass("awesome-x-color") } } _compartilhamento.find("li[ident=" + t + "]").find(".small").find("span").text("(" + i_carteirinhas + ")") } else { jAlert("Usu·rio j· selecionado.", "") } } }); $(".cart_marcar_todos").live("click", function (e) { e.preventDefault(); $(".carteirinha").each(function () { var e = $(this); if (!e.hasClass("carteirinha_selected")) { e.click() } }) }); $(".cart_desmarcar_todos").live("click", function (e) { e.preventDefault(); $(".carteirinha").each(function () { var e = $(this); if (e.hasClass("carteirinha_selected")) { e.click() } }) }); $(".fancybox-inner").find(".fechar_X").live("click", function (e) { e.preventDefault(); $.fancybox.close() }); _p_a_perso.live("click", function () { i_carteirinhas = 0; _personalizando = $(this) }); _compartilhamento.find(".small").live("click", function () { i_carteirinhas = 0; _personalizando = $(this) }) }) } })(jQuery); jQuery.fn.hasParent = function (e) { e = jQuery(e); var t = false; jQuery(this[0]).parents().andSelf().each(function () { if (jQuery.inArray(this, e) != -1) { t = true; return false } }); return t }